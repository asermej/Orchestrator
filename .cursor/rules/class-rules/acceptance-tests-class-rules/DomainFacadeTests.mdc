---
description: "ACTIVE: DomainFacadeTests rules - Acceptance testing through DomainFacade"
globs: apps/api/Orchestrator.AcceptanceTests/Domain/DomainFacadeTests*.cs
alwaysApply: false
---

>>> CONTEXT LOADED: DomainFacadeTests best practices are now active <<<

# DomainFacadeTests Best Practices

**Template**: [DomainFacadeTests.Base.hbs](mdc:docs/technical/templates/acceptance-test-templates/DomainFacadeTests.Base.hbs)

**Related Guides**:
- [Test Cleanup Guide](mdc:docs/technical/reference/guides/acceptance-test-guides/test-cleanup.md) - Database cleanup patterns and test isolation

## Purpose
Acceptance tests verify business logic **exclusively through DomainFacade**. Never test managers, data managers, or validators directly.

## Requirements

- **Test ONLY through DomainFacade**: Black-box testing of domain logic
- **Real database**: Use `ServiceLocatorForAcceptanceTesting` with real test database
- **Centralized SQL cleanup**: Call `TestDataCleanup.CleanupAllTestData()` in **both** TestInitialize and TestCleanup. No ID-tracking lists needed.
- **Organization naming convention**: All test organization names MUST start with `TestOrg_`. All test user emails MUST use `@example.com`.
- **No external mocking frameworks**: Use custom test doubles only

## Pattern

```csharp
[TestClass]
public class DomainFacadeTestsFeature
{
    private DomainFacade _domainFacade = null!;

    [TestInitialize]
    public void TestInitialize()
    {
        TestDataCleanup.CleanupAllTestData();
        _domainFacade = new DomainFacade(new ServiceLocatorForAcceptanceTesting());
    }

    [TestCleanup]
    public void TestCleanup()
    {
        try { TestDataCleanup.CleanupAllTestData(); }
        catch (Exception ex) { Console.WriteLine($"Warning: {ex.Message}"); }
        finally { _domainFacade?.Dispose(); }
    }
}
```

## Adding a New Entity Type

When adding a new entity type that acceptance tests write to:
1. Add a DELETE statement in `TestDataCleanup.CleanupAllTestData()` at the correct FK position.
2. Add a verification check in `ManualCleanup.VerifyDatabase_NoTestDataRemains`.
3. Ensure test data uses `TestOrg_` organizations.

## Do NOT

- Test managers, validators, or data managers directly
- Use external mocking frameworks (Moq, NSubstitute, etc.)
- Use ID-tracking lists for cleanup (use centralized SQL cleanup instead)
- Use organization names that don't start with `TestOrg_`
- Leave test data in the database
