using Orchestrator.Domain;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Orchestrator.AcceptanceTests.Domain;
using Orchestrator.AcceptanceTests.TestUtilities;

namespace Orchestrator.AcceptanceTests.Domain;

/// <summary>
/// Tests for {{featureName}} operations using real DomainFacade.
/// Cleanup: centralized SQL cleanup in TestInitialize/TestCleanup via TestDataCleanup.
/// All test organization names MUST start with "TestOrg_".
/// </summary>
[TestClass]
public class DomainFacadeTests{{featureName}}
{
    private DomainFacade _domainFacade = null!;

    [TestInitialize]
    public void TestInitialize()
    {
        TestDataCleanup.CleanupAllTestData();
        _domainFacade = new DomainFacade(new ServiceLocatorForAcceptanceTesting());
    }

    [TestCleanup]
    public void TestCleanup()
    {
        try { TestDataCleanup.CleanupAllTestData(); }
        catch (Exception ex) { Console.WriteLine($"Warning: {ex.Message}"); }
        finally { _domainFacade?.Dispose(); }
    }

    /// <summary>
    /// Helper method to create test {{featureName}} with unique data
    /// </summary>
    private async Task<{{featureName}}> CreateTest{{featureName}}Async(string suffix = "")
    {
        var {{camelCase featureName}} = new {{featureName}}
        {
            {{#each properties}}
            {{#if_eq type "string"}}
            {{#if_eq name "Email"}}
            {{name}} = $"test{suffix}{DateTime.Now.Ticks}@example.com",
            {{else if_eq name "Phone"}}
            {{name}} = $"+1555{DateTime.Now.Ticks.ToString().Substring(0, 7)}",
            {{else}}
            {{name}} = $"Test{suffix}{DateTime.Now.Ticks}",
            {{/if_eq}}
            {{else if_eq type "int"}}
            {{name}} = 1,
            {{else if_eq type "bool"}}
            {{name}} = true,
            {{else if_eq type "DateTime"}}
            {{name}} = DateTime.Now,
            {{else if_eq type "Guid"}}
            {{name}} = Guid.NewGuid(),
            {{else}}
            {{name}} = default({{type}}),
            {{/if_eq}}
            {{/each}}
        };

        var result = await _domainFacade.Create{{featureName}}({{camelCase featureName}});
        Assert.IsNotNull(result, "Failed to create test {{featureName}}");
        return result;
    }

    /// <summary>
    /// Simple helper method to create test {{featureName}} with basic data
    /// </summary>
    private async Task<{{featureName}}> CreateTest{{featureName}}()
    {
        var {{camelCase featureName}} = new {{featureName}}
        {
            {{#each properties}}
            {{#if_eq type "string"}}
            {{#if_eq name "Email"}}
            {{name}} = $"test{DateTime.Now.Ticks}@example.com",
            {{else if_eq name "Phone"}}
            {{name}} = "+15551234567",
            {{else}}
            {{name}} = $"Test{DateTime.Now.Ticks}",
            {{/if_eq}}
            {{else if_eq type "int"}}
            {{name}} = 1,
            {{else if_eq type "bool"}}
            {{name}} = true,
            {{else if_eq type "DateTime"}}
            {{name}} = DateTime.Now,
            {{else if_eq type "Guid"}}
            {{name}} = Guid.NewGuid(),
            {{else}}
            {{name}} = default({{type}}),
            {{/if_eq}}
            {{/each}}
        };

        var result = await _domainFacade.Create{{featureName}}({{camelCase featureName}});
        return result;
    }

    {{#if (includes operations "Create")}}
    [TestMethod]
    public async Task Create{{featureName}}_ValidData_ReturnsCreated{{featureName}}()
    {
        // Arrange
        var {{camelCase featureName}} = new {{featureName}}
        {
            {{#each properties}}
            {{#if_eq type "string"}}
            {{#if_eq name "Email"}}
            {{name}} = $"{{#lowerCase}}{{name}}{{/lowerCase}}{DateTime.Now.Ticks}@example.com",
            {{else if_eq name "Phone"}}
            {{name}} = $"+1555{DateTime.Now.Ticks.ToString().Substring(0, 7)}",
            {{else}}
            {{name}} = $"{{#lowerCase}}{{name}}{{/lowerCase}}{DateTime.Now.Ticks}",
            {{/if_eq}}
            {{else if_eq type "int"}}
            {{name}} = 1,
            {{else if_eq type "bool"}}
            {{name}} = true,
            {{else if_eq type "DateTime"}}
            {{name}} = DateTime.Now,
            {{else if_eq type "Guid"}}
            {{name}} = Guid.NewGuid(),
            {{else}}
            {{name}} = default({{type}}),
            {{/if_eq}}
            {{/each}}
        };

        // Act
        var result = await _domainFacade.Create{{featureName}}({{camelCase featureName}});

        // Assert
        Assert.IsNotNull(result, "Create should return a {{featureName}}");
        Assert.AreNotEqual(Guid.Empty, result.Id, "{{featureName}} should have a valid ID");
        {{#each properties}}
        {{#if_eq type "string"}}
        Assert.AreEqual({{camelCase ../featureName}}.{{name}}, result.{{name}});
        {{/if_eq}}
        {{/each}}
    }

    [TestMethod]
    public async Task Create{{featureName}}_InvalidData_ThrowsValidationException()
    {
        // Arrange - {{featureName}} with empty required fields
        var {{camelCase featureName}} = new {{featureName}}
        {
            {{#each properties}}
            {{#if_eq type "string"}}
            {{name}} = "",
            {{else if_eq type "int"}}
            {{name}} = -1,
            {{else if_eq type "bool"}}
            {{name}} = false,
            {{else if_eq type "DateTime"}}
            {{name}} = DateTime.MinValue,
            {{else if_eq type "Guid"}}
            {{name}} = Guid.Empty,
            {{else}}
            {{name}} = default({{type}}),
            {{/if_eq}}
            {{/each}}
        };

        // Act & Assert
        await Assert.ThrowsExceptionAsync<{{featureName}}ValidationException>(() =>
            _domainFacade.Create{{featureName}}({{camelCase featureName}}), "Should throw validation exception for invalid data");
    }
    {{/if}}

    {{#if (includes operations "GetById")}}
    [TestMethod]
    public async Task Get{{featureName}}ById_ExistingId_Returns{{featureName}}()
    {
        // Arrange
        var created{{featureName}} = await CreateTest{{featureName}}Async();

        // Act
        var result = await _domainFacade.Get{{featureName}}ById(created{{featureName}}.Id);

        // Assert
        Assert.IsNotNull(result, $"Should return {{featureName}} with ID: {created{{featureName}}.Id}");
        Assert.AreEqual(created{{featureName}}.Id, result.Id);
        {{#each properties}}
        {{#if_eq type "string"}}
        Assert.AreEqual(created{{featureName}}.{{name}}, result.{{name}});
        {{/if_eq}}
        {{/each}}
    }

    [TestMethod]
    public async Task Get{{featureName}}ById_NonExistingId_ThrowsNotFoundException()
    {
        // Arrange
        var nonExistingId = Guid.NewGuid();

        // Act & Assert
        await Assert.ThrowsExceptionAsync<{{featureName}}NotFoundException>(() =>
            _domainFacade.Get{{featureName}}ById(nonExistingId),
            "Should throw exception for non-existing ID");
    }
    {{/if}}

    {{#if (includes operations "Search")}}
    [TestMethod]
    public async Task Search{{featureName}}s_WithResults_ReturnsPaginatedList()
    {
        // Arrange
        var {{camelCase featureName}}1 = await CreateTest{{featureName}}Async("Test1");
        var {{camelCase featureName}}2 = await CreateTest{{featureName}}Async("Test2");

        // Act
        var result = await _domainFacade.Search{{featureName}}s({{#each searchableFields}}{{#if @first}}"Test"{{else}}null{{/if}}{{#unless @last}}, {{/unless}}{{/each}}, 1, 10);

        // Assert
        Assert.IsNotNull(result, "Search should return results");
        Assert.IsTrue(result.TotalCount >= 2, $"Should find at least 2 {{featureName}}s, found {result.TotalCount}");
        Assert.IsTrue(result.Items.Count() >= 2, $"Should return at least 2 items, returned {result.Items.Count()}");
    }

    [TestMethod]
    public async Task Search{{featureName}}s_NoResults_ReturnsEmptyList()
    {
        // Act
        var result = await _domainFacade.Search{{featureName}}s({{#each searchableFields}}"NonExistentSearchTerm"{{#unless @last}}, {{else}}, {{/unless}}{{/each}}1, 10);

        // Assert
        Assert.IsNotNull(result, "Search should return results even if empty");
        Assert.AreEqual(0, result.TotalCount, "Should return 0 results for non-existent search term");
        Assert.IsFalse(result.Items.Any(), "Items should be empty");
    }
    {{/if}}

    {{#if (includes operations "Update")}}
    [TestMethod]
    public async Task Update{{featureName}}_ValidData_UpdatesSuccessfully()
    {
        // Arrange
        var {{camelCase featureName}} = await CreateTest{{featureName}}Async();
        {{#each properties}}
        {{#if_eq type "string"}}
        {{#if_eq name "Email"}}
        {{camelCase ../featureName}}.{{name}} = $"updated{DateTime.Now.Ticks}@example.com";
        {{else}}
        {{camelCase ../featureName}}.{{name}} = $"Updated{DateTime.Now.Ticks}";
        {{/if_eq}}
        {{/if_eq}}
        {{/each}}

        // Act
        var result = await _domainFacade.Update{{featureName}}({{camelCase featureName}});

        // Assert
        Assert.IsNotNull(result, "Update should return the updated {{featureName}}");
        {{#each properties}}
        {{#if_eq type "string"}}
        Assert.AreEqual({{camelCase ../featureName}}.{{name}}, result.{{name}});
        {{/if_eq}}
        {{/each}}
    }

    [TestMethod]
    public async Task Update{{featureName}}_InvalidData_ThrowsValidationException()
    {
        // Arrange
        var {{camelCase featureName}} = await CreateTest{{featureName}}Async();
        {{#each properties}}
        {{#if_eq type "string"}}
        {{camelCase ../featureName}}.{{name}} = "";
        {{/if_eq}}
        {{/each}}

        // Act & Assert
        await Assert.ThrowsExceptionAsync<{{featureName}}ValidationException>(() =>
            _domainFacade.Update{{featureName}}({{camelCase featureName}}),
            "Should throw validation exception for invalid data");
    }
    {{/if}}

    {{#if (includes operations "Delete")}}
    [TestMethod]
    public async Task Delete{{featureName}}_ExistingId_DeletesSuccessfully()
    {
        // Arrange
        var {{camelCase featureName}} = await CreateTest{{featureName}}Async();
        var id = {{camelCase featureName}}.Id;

        // Act
        var result = await _domainFacade.Delete{{featureName}}(id);

        // Assert
        Assert.IsTrue(result, "Should return true when deleting existing {{featureName}}");
        await Assert.ThrowsExceptionAsync<{{featureName}}NotFoundException>(() =>
            _domainFacade.Get{{featureName}}ById(id),
            "Should not find deleted {{featureName}}");
    }

    [TestMethod]
    public async Task Delete{{featureName}}_NonExistingId_ReturnsFalse()
    {
        // Arrange
        var nonExistingId = Guid.NewGuid();

        // Act
        var result = await _domainFacade.Delete{{featureName}}(nonExistingId);

        // Assert
        Assert.IsFalse(result, "Should return false for non-existing ID");
    }
    {{/if}}

    [TestMethod]
    public async Task {{featureName}}LifecycleTest_CreateGetUpdateSearchDelete_WorksCorrectly()
    {
        // Create
        var {{camelCase featureName}} = await CreateTest{{featureName}}Async("Lifecycle");
        Assert.IsNotNull({{camelCase featureName}}, "{{featureName}} should be created");
        var createdId = {{camelCase featureName}}.Id;

        // Get
        var retrieved{{featureName}} = await _domainFacade.Get{{featureName}}ById(createdId);
        Assert.IsNotNull(retrieved{{featureName}}, "Should retrieve created {{featureName}}");
        Assert.AreEqual(createdId, retrieved{{featureName}}.Id);

        // Update
        {{#each properties}}
        {{#if_eq type "string"}}
        {{#if_eq name "Email"}}
        retrieved{{featureName}}.{{name}} = $"updated{DateTime.Now.Ticks}@example.com";
        {{else}}
        retrieved{{featureName}}.{{name}} = $"Updated{DateTime.Now.Ticks}";
        {{/if_eq}}
        {{/if_eq}}
        {{/each}}
        var updated{{featureName}} = await _domainFacade.Update{{featureName}}(retrieved{{featureName}});
        Assert.IsNotNull(updated{{featureName}}, "Should update {{featureName}}");

        // Search
        var searchResult = await _domainFacade.Search{{featureName}}s({{#each searchableFields}}{{#if @first}}"Updated"{{else}}null{{/if}}{{#unless @last}}, {{/unless}}{{/each}}, 1, 10);
        Assert.IsNotNull(searchResult, "Search should return results");
        Assert.IsTrue(searchResult.TotalCount > 0, "Should find updated {{featureName}}");

        // Delete
        var deleteResult = await _domainFacade.Delete{{featureName}}(createdId);
        Assert.IsTrue(deleteResult, "Should successfully delete {{featureName}}");
        await Assert.ThrowsExceptionAsync<{{featureName}}NotFoundException>(() =>
            _domainFacade.Get{{featureName}}ById(createdId),
            "Should not find deleted {{featureName}}");
    }
}
