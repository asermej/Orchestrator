<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- ================================================================== -->
    <!-- UPDATE INTERVIEW GUIDE VISIBILITY_SCOPE VALUES AND ADD CHECK        -->
    <!-- ================================================================== -->

    <!-- Step 1: Migrate existing 'owner_only' values to 'organization_only' -->
    <changeSet id="20260216190000-migrate-ig-visibility-scope-values" author="system">
        <sql>
            UPDATE interview_guides
            SET visibility_scope = 'organization_only'
            WHERE visibility_scope = 'owner_only';
        </sql>
    </changeSet>

    <!-- Step 2: Update the column default -->
    <changeSet id="20260216190000-update-ig-visibility-scope-default" author="system">
        <dropDefaultValue tableName="interview_guides" columnName="visibility_scope"/>
        <addDefaultValue tableName="interview_guides" columnName="visibility_scope" defaultValue="organization_only"/>
    </changeSet>

    <!-- Step 3: Add CHECK constraint for allowed values -->
    <changeSet id="20260216190000-add-ig-visibility-scope-check-constraint" author="system">
        <sql>
            ALTER TABLE interview_guides
            ADD CONSTRAINT chk_interview_guides_visibility_scope
            CHECK (visibility_scope IN ('organization_only', 'organization_and_descendants', 'descendants_only'));
        </sql>
    </changeSet>

</databaseChangeLog>
